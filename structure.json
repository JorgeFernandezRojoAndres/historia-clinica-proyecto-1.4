{
  "app": {
    "controllers": {
      "pacientesController.js": "// app/controllers/pacientesController.js\nconst db = require('../../config/database');\n\nexports.listAll = (req, res) => {\n    const sql = 'SELECT idPaciente, nombre, fechaNacimiento, dni, direccion, telefono FROM pacientes';\n    db.query(sql, (error, results) => {\n      if (error) {\n        console.error('Error al obtener los pacientes:', error);\n        return res.status(500).send('Error al obtener los pacientes');\n      }\n  \n      results.forEach(paciente => {\n        paciente.fechaNacimiento = new Date(paciente.fechaNacimiento).toLocaleDateString('es-ES', {\n          year: 'numeric', month: 'long', day: 'numeric'\n        });\n      });\n  \n      // Verificar si la solicitud es AJAX\n      if (req.xhr) {\n        return res.json(results); // Devolver JSON si es AJAX\n      }\n  \n      res.render('pacientes', { pacientes: results }); // Renderizar la vista si es navegaci√≥n normal\n    });\n  };\n  \n\n  exports.showRegisterForm = (req, res) => {\n    // Obtener el idClinica desde la sesi√≥n\n    const idClinica = req.session.idClinica;\n\n    // Verificar si se ha seleccionado una cl√≠nica\n    if (!idClinica) {\n        console.log('No se ha seleccionado una cl√≠nica, redirigiendo a la selecci√≥n de cl√≠nica.');\n        return res.redirect('/seleccion-clinica'); // Redirige a la selecci√≥n de cl√≠nica si no hay una cl√≠nica seleccionada\n    }\n\n    // Consulta para obtener m√©dicos de la cl√≠nica seleccionada\n    const query = `\n        SELECT m.*\n        FROM medicos AS m\n        JOIN medicos_clinicas AS mc ON m.idMedico = mc.idMedico\n        WHERE mc.idClinica = ?;\n    `;\n\n    db.query(query, [idClinica], (error, medicos) => {\n        if (error) {\n            console.error('Error al obtener los m√©dicos:', error);\n            return res.status(500).send('Error al obtener los m√©dicos');\n        }\n\n        // Verificar si se encontraron m√©dicos\n        if (medicos.length === 0) {\n            console.log('No se encontraron m√©dicos para la cl√≠nica seleccionada.');\n            return res.status(404).send('No se encontraron m√©dicos para la cl√≠nica seleccionada.');\n        }\n\n        // Renderizar el formulario de nuevo paciente con la lista de m√©dicos de la cl√≠nica seleccionada\n        res.render('new_pacientes', { medicos });\n    });\n};\n\n\n\nexports.create = (req, res) => {\n    const { nombre, fechaNacimiento, dni, direccion, telefono } = req.body;\n    console.log('Creando nuevo paciente:', { nombre, fechaNacimiento, dni, direccion, telefono });\n\n    const sql = 'INSERT INTO pacientes (nombre, fechaNacimiento, dni, direccion, telefono, estado) VALUES (?, ?, ?, ?, ?, \"Pendiente\")';\n    \n    db.query(sql, [nombre, fechaNacimiento, dni, direccion, telefono], (error, results) => {\n        if (error) {\n            console.error('Error al crear el paciente:', error);\n            return res.status(500).send(\"Error al crear el paciente\");\n        }\n        \n        console.log('Paciente creado exitosamente');\n\n        // Redirige dependiendo de si el usuario est√° autenticado y su rol\n        if (req.session.user && req.session.user.role === 'secretaria') {\n            return res.redirect('/register/paciente'); // Redirige a la ruta para secretarias\n        } else {\n            return res.redirect('/registro-pendiente'); // Redirige a la ruta para an√≥nimos\n        }\n    });\n};\n\n\n\n\nexports.showEditForm = (req, res) => {\n    const id = req.params.id;\n    const sql = 'SELECT * FROM pacientes WHERE idPaciente = ?';\n\n    db.query(sql, [id], (error, results) => {\n        if (error) {\n            console.error('Error al obtener el paciente:', error);\n            return res.status(500).send('Error al obtener el paciente');\n        }\n\n        if (results.length === 0) {\n            return res.status(404).send('Paciente no encontrado');\n        }\n\n        // Formatear la fecha de nacimiento en formato ISO para el campo 'date'\n        results[0].fechaNacimiento = new Date(results[0].fechaNacimiento).toISOString().split('T')[0];\n\n        res.render('editPaciente', { paciente: results[0] });\n    });\n};\n\n\nexports.update = (req, res) => {\n    const { nombre, fechaNacimiento, dni, direccion, telefono } = req.body;\n    const id = req.params.id;\n\n    const sql = 'UPDATE pacientes SET nombre = ?, fechaNacimiento = ?, dni = ?, direccion = ?, telefono = ? WHERE idPaciente = ?';\n    db.query(sql, [nombre, fechaNacimiento, dni, direccion, telefono, id], (error, results) => {\n        if (error) {\n            console.error('Error al actualizar el paciente:', error);\n            return res.status(500).send(\"Error al actualizar el paciente\");\n        }\n\n        // Redirigir seg√∫n el rol del usuario\n        if (req.session.user.role === 'secretaria') {\n            res.redirect('/secretaria/pacientes'); // Redirige a la lista de pacientes si es secretaria\n        } else if (req.session.user.role === 'paciente') {\n            res.redirect('/paciente/mi-perfil'); // Redirige al perfil del paciente\n        } else {\n            res.redirect('/'); \n        }\n    });\n};\n\n\n\nexports.delete = (req, res) => {\n    console.log('Intentando eliminar paciente con ID:', req.params.id);\n    const id = req.params.id;\n    const sql = 'DELETE FROM pacientes WHERE idPaciente = ?';\n\n    db.query(sql, [id], (error, results) => {\n        if (error) {\n            console.error('Error al eliminar el paciente:', error);\n            return res.status(500).send('Error al eliminar el paciente');\n        }\n        res.redirect('/secretaria/pacientes');\n    });\n};\n\n\n\n\nexports.buscarPaciente = (req, res) => {\n    const dni = req.params.dni;\n    const sql = `SELECT p.nombre, hc.detalles \n                 FROM pacientes p \n                 LEFT JOIN historias_clinicas hc \n                 ON p.idPaciente = hc.idPaciente \n                 WHERE p.dni = ?`;\n    \n    db.query(sql, [dni], (error, results) => {\n        if (error) {\n            return res.status(500).json({ success: false, message: 'Error al buscar paciente' });\n        }\n        if (results.length > 0) {\n            const paciente = results[0];\n            res.json({ \n                success: true, \n                nombre: paciente.nombre, \n                detalles: paciente.detalles || 'Sin historial cl√≠nico'\n            });\n        } else {\n            res.json({ success: false, message: 'Paciente no encontrado' });\n        }\n    });\n};\n\nexports.search = (req, res) => {\n    const query = req.query.query || ''; \n    console.log(\"Ejecutando b√∫squeda de pacientes con query:\", query);\n\n    if (query.trim().length === 0) {\n        return res.status(400).json({ message: 'La b√∫squeda no puede estar vac√≠a.' });\n    }\n\n    const searchTerm = `%${query}%`;\n    const sql = 'SELECT * FROM pacientes WHERE nombre LIKE ?';\n\n    db.query(sql, [searchTerm], (error, results) => {\n        if (error) {\n            console.error('Error al buscar pacientes:', error);\n            return res.status(500).send('Error al buscar pacientes');\n        }\n\n        console.log(\"Resultados de b√∫squeda:\", results);\n\n        if (results.length > 0) {\n            res.json(results); // Devuelve resultados como JSON\n        } else {\n            res.json({ message: 'No se encontraron pacientes.' });\n        }\n    });\n};\n\nexports.showProfile = (req, res) => { \n    const idPaciente = req.session.user.id; // Obtiene el ID del paciente desde la sesi√≥n\n\n    // Consulta para obtener la informaci√≥n del paciente\n    const sql = 'SELECT * FROM pacientes WHERE idPaciente = ?';\n    db.query(sql, [idPaciente], (error, results) => {\n        if (error) {\n            console.error('Error al buscar paciente:', error);\n            return res.status(500).send('Error al buscar paciente');\n        }\n\n        if (results.length > 0) {\n            const paciente = results[0];\n\n            // Verificar si el estado del paciente es \"Pendiente\"\n            if (paciente.estado === 'Pendiente') {\n                return res.redirect('/espera-aprobacion'); // Redirige a la p√°gina de espera si el estado es \"Pendiente\"\n            }\n\n            res.render('perfilPaciente', { paciente }); // Si el paciente est√° aprobado, mostrar su perfil\n        } else {\n            res.status(404).send('Paciente no encontrado');\n        }\n    });\n};\n\n\n// Mostrar pacientes pendientes\nexports.showPendingPatients = (req, res) => {\n  const sql = 'SELECT * FROM pacientes WHERE estado = \"Pendiente\"';\n  db.query(sql, (error, results) => {\n    if (error) {\n      console.error('Error al obtener pacientes pendientes:', error);\n      return res.status(500).send('Error al obtener pacientes pendientes');\n    }\n    res.render('adminPacientesPendientes', { pacientesPendientes: results });\n  });\n};\n\n// Confirmar paciente\nexports.confirmPatient = (req, res) => {\n  const idPaciente = req.params.idPaciente; \n  const sql = 'UPDATE pacientes SET estado = \"Activo\" WHERE idPaciente = ?'; // Cambia el estado a \"Activo\"\n  db.query(sql, [idPaciente], (error, results) => {\n    if (error) {\n      console.error('Error al confirmar paciente:', error);\n      return res.status(500).send('Error al confirmar paciente');\n    }\n    res.redirect('/admin/pacientes-pendientes'); // Redirige a la lista de pacientes pendientes\n  });\n};\n\n// Rechazar paciente\nexports.rejectPatient = (req, res) => {\n  const idPaciente = req.params.idPaciente; \n  const sql = 'DELETE FROM pacientes WHERE idPaciente = ?'; // Elimina el paciente de la base de datos\n  db.query(sql, [idPaciente], (error, results) => {\n    if (error) {\n      console.error('Error al rechazar paciente:', error);\n      return res.status(500).send('Error al rechazar paciente');\n    }\n    res.redirect('/admin/pacientes-pendientes'); // Redirige a la lista de pacientes pendientes\n  });\n};\n\nexports.rejectPatient = (req, res) => {\n    const idPaciente = req.params.idPaciente; // üëà coincide con la ruta\n    const sql = 'DELETE FROM pacientes WHERE idPaciente = ?';\n    db.query(sql, [idPaciente], (error, results) => {\n        if (error) {\n            console.error('Error al rechazar paciente:', error);\n            return res.status(500).send('Error al rechazar paciente');\n        }\n        res.redirect('/admin/pacientes-pendientes');\n    });\n};\n\nexports.history = (req, res) => {\n    const idPaciente = req.session.user.id; // ID del paciente logueado\n\n    const sql = `\n        SELECT \n            c.idCita,\n            m.nombre AS nombreMedico,\n            DATE_FORMAT(c.fechaHora, '%d/%m/%Y %H:%i') AS fechaHora,\n            c.motivoConsulta,\n            c.estado\n        FROM citas c\n        LEFT JOIN medicos m ON c.idMedico = m.idMedico\n        WHERE c.idPaciente = ?\n        ORDER BY c.fechaHora DESC\n    `;\n\n    db.query(sql, [idPaciente], (error, results) => {\n        if (error) {\n            console.error('Error al obtener historial:', error);\n            return res.status(500).send('Error al obtener historial');\n        }\n\n        res.render('historialPaciente', {\n            historial: results,\n            nombrePaciente: req.session.user.nombre\n        });\n    });\n};\n"
    },
    "views": {
      "esperaAprobacion.pug": "extends layout\r\n\r\nblock content\r\n  h1 Tu registro est√° pendiente de confirmaci√≥n\r\n  p Tu cuenta est√° esperando ser aprobada por un administrador.\r\n  p Por favor, contacta a la cl√≠nica al n√∫mero de tel√©fono <strong>(XXXX) XXXX-XXXX</strong> para m√°s informaci√≥n.\r\n  a(href='/login') Volver al login\r\n"
    }
  },
  "routes": {
    "pacientes.js": "const express = require('express');\nconst router = express.Router();\nconst pacientesController = require('../app/controllers/pacientesController');\nconst authMiddleware = require('../middleware/roleMiddleware');\n\n// Verificar si los middlewares est√°n definidos\nconsole.log('authMiddleware.isAuthenticated:', authMiddleware.isAuthenticated);\nconsole.log('authMiddleware.isAdmin:', authMiddleware.isAdmin);\n\n// Ruta para que el paciente vea su propio perfil\nrouter.get('/mi-perfil', authMiddleware.isAuthenticated, authMiddleware.isPaciente, (req, res) => {\n    console.log('Accediendo a la ruta /mi-perfil'); // Log para acceder a mi-perfil\n    pacientesController.showProfile(req, res);\n});\n\n// Redirigir a los pacientes que acceden a /pacientes a su perfil\nrouter.get('/', authMiddleware.isAuthenticated, authMiddleware.isPaciente, (req, res) => {\n    console.log('Redirigiendo a /mi-perfil'); // Log para redirecci√≥n\n    res.redirect('/paciente/mi-perfil');\n});\n\n// Ruta para mostrar el formulario de editar un paciente (acceso solo para el paciente)\nrouter.get('/edit/:id', authMiddleware.isAuthenticated, authMiddleware.isPaciente, (req, res) => {\n    console.log(`Accediendo a la ruta /edit/${req.params.id}`); // Log para ver la edici√≥n\n    pacientesController.showEditForm(req, res);\n});\n\n// Ruta para actualizar un paciente\nrouter.post('/update/:id', authMiddleware.isAuthenticated, authMiddleware.isPaciente, (req, res) => {\n    console.log(`Actualizando paciente con ID: ${req.params.id}`); // Log para actualizaci√≥n\n    pacientesController.update(req, res);\n});\n\n// Ruta para mostrar el formulario de registro de un nuevo paciente\nrouter.get('/register', (req, res) => {\n    console.log('Accediendo a la ruta /register'); // Log para acceso a registro\n    pacientesController.showRegisterForm(req, res);\n});\n\n// Ruta para crear un nuevo paciente\nrouter.post('/', (req, res) => {\n    console.log('Creando nuevo paciente:', req.body); // Log para mostrar los datos del nuevo paciente\n    pacientesController.create(req, res);\n});\n\n// Ruta para mostrar pacientes pendientes de confirmaci√≥n\nrouter.get('/admin/pacientes-pendientes', authMiddleware.isAuthenticated, authMiddleware.isAdministrador, (req, res) => {\n    console.log('Accediendo a la ruta /admin/pacientes-pendientes'); // Log para acceso a pacientes pendientes\n    pacientesController.showPendingPatients(req, res);\n});\n\n// Ruta para mostrar mensaje de registro pendiente\nrouter.get('/registro-pendiente', (req, res) => {\n    console.log('Accediendo a la ruta /registro-pendiente'); // Log para acceso a registro pendiente\n    res.render('registro-pendiente'); // Aseg√∫rate de tener la vista `registroPendiente.pug`\n});\n\n// Ruta para confirmar un paciente\nrouter.post('/admin/confirmar-paciente/:id', authMiddleware.isAuthenticated, authMiddleware.isAdministrador, (req, res) => {\n    console.log(`Confirmando paciente con ID: ${req.params.id}`); // Log para confirmar paciente\n    pacientesController.confirmPatient(req, res);\n});\n\n// Ruta para rechazar un paciente\nrouter.post('/admin/rechazar-paciente/:id', authMiddleware.isAuthenticated, authMiddleware.isAdministrador, (req, res) => {\n    console.log(`Rechazando paciente con ID: ${req.params.id}`); // Log para rechazar paciente\n    pacientesController.rejectPatient(req, res);\n});\n// Ruta para la p√°gina de espera de confirmaci√≥n\nrouter.get('/espera-aprobacion', (req, res) => {\n    res.render('esperaAprobacion'); // Renderiza la vista 'esperaAprobacion'\n});\n\n\n// **Nueva Ruta para Buscar Pacientes**\nrouter.get('/search', authMiddleware.isAuthenticated, authMiddleware.isSecretaria, (req, res) => {\n    const query = req.query.query; // Obtener la query desde los par√°metros de la URL\n    console.log('Buscando pacientes con query:', query); // Log para buscar pacientes\n\n    pacientesController.search(query, (error, results) => {\n        if (error) {\n            console.error('Error al buscar pacientes:', error);\n            return res.status(500).send('Error al buscar pacientes');\n        }\n        console.log('Resultados de la b√∫squeda:', results); // Log para ver los resultados de b√∫squeda\n        res.json(results); // Devolver los resultados como JSON\n    });\n});\n\n\nmodule.exports = router;\n"
  }
}